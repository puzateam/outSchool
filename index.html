<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการลา และขออนุญาตออกนอกสถานศึกษา</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* ... CSS Global, Header, Nav, Main, View Container, Charts, Swal, Buttons เหมือนเดิม ... */
        body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        header { background: linear-gradient(135deg, #D32F2F, #FFC107); color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { display: flex; flex-direction: column; align-items: center; max-width: 1200px; margin: 0 auto; }
        #logo { max-height: 70px; width: auto; margin-bottom: 10px; border-radius: 5px; }
        #system-name { font-size: 1.4em; margin: 0; font-weight: 500; line-height: 1.2; }
        nav { background-color: #ffffff; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid #eee; }
        nav ul { list-style-type: none; padding: 0; margin: 0; display: flex; justify-content: center; flex-wrap: wrap; }
        nav ul li a { display: block; color: #333; text-align: center; padding: 14px 20px; text-decoration: none; font-weight: 500; transition: background-color 0.3s, color 0.3s; border-bottom: 3px solid transparent; }
        nav ul li a:hover, nav ul li a.active { color: #D32F2F; background-color: #FFF9C4; border-bottom-color: #D32F2F; }
        .admin-logout a { color: #555; }
        .admin-logout a:hover { background-color: #ffebee; color: #c0392b; border-bottom-color: #c0392b; }
        main { flex-grow: 1; padding: 20px; max-width: 1200px; width: 100%; margin: 0 auto; box-sizing: border-box; }
        .view-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-container h2 { color: #D32F2F; border-bottom: 2px solid #FFC107; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; font-weight: 500; }
        .view-container h2 i { margin-right: 8px; }
        .charts-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-wrapper { flex: 1 1 45%; min-width: 280px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 400px; display: flex; flex-direction: column; }
        .chart-wrapper h3 { text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #555; flex-shrink: 0; }
        .chart-canvas-container { flex-grow: 1; position: relative; overflow: hidden; }
        .swal2-html-container { text-align: left !important; }
        .swal2-input, .swal2-textarea, .swal2-select { font-family: 'Prompt', sans-serif !important; margin-bottom: 10px !important; border-radius: 4px !important; border: 1px solid #ddd !important; padding: 10px !important; width: calc(100% - 20px) !important; box-sizing: border-box !important; }
        .swal2-label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .swal2-title { font-family: 'Prompt', sans-serif !important; color: #D32F2F !important; }
        .swal2-confirm { background-color: #D32F2F !important; font-family: 'Prompt', sans-serif !important; }
        .swal2-cancel { font-family: 'Prompt', sans-serif !important; }
        .swal2-validation-message { font-family: 'Prompt', sans-serif !important; }
        .swal2-popup { width: 600px !important; max-width: 90% !important; }
        @media (min-width: 768px) { .swal2-popup { width: 700px !important; max-width: 700px !important; } }
        @media (max-width: 767px) { .swal2-popup { width: 90vw !important; max-width: 90vw !important; } }
        @media (max-width: 480px) { .swal2-popup { width: 95vw !important; max-width: 95vw !important; } }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 1em; transition: background-color 0.3s, transform 0.1s; margin-right: 5px; margin-bottom: 5px; }
        .btn:active { transform: translateY(1px); }
        .btn-approve { background-color: #2ecc71; color: white; } .btn-approve:hover { background-color: #27ae60; }
        .btn-reject { background-color: #e74c3c; color: white; } .btn-reject:hover { background-color: #c0392b; }
        .btn-delete { background-color: #95a5a6; color: white; } .btn-delete:hover { background-color: #7f8c8d; }

        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px 10px; vertical-align: middle; }
        th { background-color: #ecf0f1; font-weight: 500; color: #2c3e50; text-align: center; }
        td {
            text-align: left;
            color: #34495e; /* Darker text color for table data */
            font-weight: 400; /* Normal font weight for readability */
        }
        td.cell-center, table td:first-child /* "ลำดับ" column */ {
            text-align: center;
        }
        /* Specific centering for status columns in different tables */
        .dashboard-table td:nth-child(7) { text-align: center; } /* Status column in main dashboard */
        .admin-dashboard-table td:nth-child(6) { text-align: center; } /* Status column in admin dashboard */

        tr:nth-child(even) { background-color: #f8f9f9; } /* Slightly off-white for even rows */
        tr:hover { background-color: #e9ecef; } /* Lighter hover */
        .status-pending { background-color: #f1c40f !important; color: #fff !important; }
        .status-approved { background-color: #2ecc71 !important; color: #fff !important; }
        .status-rejected { background-color: #e74c3c !important; color: #fff !important; }
        .no-data { text-align: center; font-style: italic; color: #777; padding: 20px; }
        .filter-search-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-search-container label { margin-right: 5px; font-weight: 500; }
        .search-input, .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Prompt', sans-serif; }
        .search-input { flex-grow: 1; } .filter-select { min-width: 180px; }
        footer { background-color: #34495e; color: #bdc3c7; text-align: center; padding: 15px; font-size: 0.9em; margin-top: auto; }
        @media (max-width: 992px) { .chart-wrapper { flex-basis: 100%; max-width: 100%; height: 320px; } }
        @media (max-width: 768px) { #system-name { font-size: 1.2em; } #logo { max-height: 60px; } nav ul { flex-direction: column; } nav ul li a { padding: 12px 10px; border-bottom-width: 2px; } .charts-container { flex-direction: column; } .chart-wrapper { min-width: unset; width: 100%; max-width: 100%; height: 350px; } .filter-search-container { flex-direction: column; align-items: stretch; } .filter-search-container label { margin-bottom: 5px;} .filter-search-container .search-input, .filter-search-container .filter-select { width: 100%; margin-bottom:10px;} .btn { width: 100%; margin-bottom: 10px; margin-right: 0;} .table-responsive td, .table-responsive th { font-size: 0.9em; padding: 8px;} }
        @media (max-width: 480px) { #system-name { font-size: 1em; } #logo { max-height: 50px; } .view-container h2 { font-size: 1.3em; } .chart-wrapper { height: 300px; } }
    </style>
</head>
<body>
    <div id="app">
        <header> <!-- ... Header content ... --> </header>
        <nav> <!-- ... Nav content ... --> </nav>

        <main>
            <!-- View: Dashboard -->
            <div v-if="currentView === 'dashboardView'" class="view-container">
                <h2><i class="fas fa-tachometer-alt"></i> แดชบอร์ด - ภาพรวมการลาและขออนุญาต (เดือนปัจจุบัน)</h2>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3>สถิติการลา (แยกตามวันในเดือนปัจจุบัน)</h3>
                        <div class="chart-canvas-container">
                           <canvas id="leaveDailyChart"></canvas> <!-- Changed ID -->
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <h3>สถิติการขออนุญาตออกนอกฯ (แยกตามวันในเดือนปัจจุบัน)</h3>
                         <div class="chart-canvas-container">
                            <canvas id="permissionDailyChart"></canvas> <!-- Changed ID -->
                        </div>
                    </div>
                </div>

                <div class="filter-search-container"> <!-- Filters for table below -->
                    <input type="text" v-model="searchTerm" placeholder="ค้นหาชื่อผู้ขอ, เหตุผล..." class="search-input">
                    <select v-model="filterStatus" class="filter-select">
                        <option value="">สถานะทั้งหมด</option>
                        <option value="รอพิจารณา">รอพิจารณา</option>
                        <option value="อนุมัติ">อนุมัติ</option>
                        <option value="ไม่อนุมัติ">ไม่อนุมัติ</option>
                    </select>
                </div>
                <div class="table-responsive">
                    <table class="dashboard-table">
                        <!-- Table headers and body (เหมือนเดิม) -->
                    </table>
                </div>
            </div>

            <!-- View: Admin Dashboard -->
            <!-- ... Admin Dashboard content (เหมือนเดิม) ... -->
        </main>

        <footer> <!-- ... Footer content ... --> </footer>
    </div>

    <script>
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrmn6WLJfs5q7ye3Mo95kEraPE8BuXdSHji0Ekwlr9JO20zPrIap0ujQnqAG2wah-W/exec';

        const app = new Vue({
            el: '#app',
            data: {
                // ... (data properties อื่นๆ เหมือนเดิม) ...
                leaveDailyChartInstance: null, // Renamed from leaveMonthlyChartInstance
                permissionDailyChartInstance: null, // Renamed from permissionMonthlyChartInstance
            },
            computed: {
                // Data for "การลา" daily chart (current month)
                leaveDailyChartDataCurrentMonth() {
                    const dailyData = {}; // { 'DD': { 'รอพิจารณา': 0, 'อนุมัติ': 0, 'ไม่อนุมัติ': 0 } }
                    const currentMonth = new Date().getMonth(); // 0-11
                    const currentYear = new Date().getFullYear();
                    const leaveRequests = this.requests.filter(req => req.requestType === 'ลา');

                    leaveRequests.forEach(req => {
                        if (req.leaveDate) {
                            const leaveDateObj = new Date(req.leaveDate);
                            if (leaveDateObj.getMonth() === currentMonth && leaveDateObj.getFullYear() === currentYear) {
                                const dayOfMonth = String(leaveDateObj.getDate()).padStart(2, '0'); // DD
                                if (!dailyData[dayOfMonth]) {
                                    dailyData[dayOfMonth] = { 'รอพิจารณา': 0, 'อนุมัติ': 0, 'ไม่อนุมัติ': 0 };
                                }
                                if (dailyData[dayOfMonth].hasOwnProperty(req.status)) {
                                    dailyData[dayOfMonth][req.status]++;
                                }
                            }
                        }
                    });
                    return dailyData;
                },
                // Data for "ขออนุญาตออกนอกสถานศึกษา" daily chart (current month)
                permissionDailyChartDataCurrentMonth() {
                    const dailyData = {};
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    const permissionRequests = this.requests.filter(req => req.requestType === 'ขออนุญาตออกนอกสถานศึกษา');

                    permissionRequests.forEach(req => {
                         if (req.leaveDate) {
                            const leaveDateObj = new Date(req.leaveDate);
                             if (leaveDateObj.getMonth() === currentMonth && leaveDateObj.getFullYear() === currentYear) {
                                const dayOfMonth = String(leaveDateObj.getDate()).padStart(2, '0');
                                if (!dailyData[dayOfMonth]) {
                                    dailyData[dayOfMonth] = { 'รอพิจารณา': 0, 'อนุมัติ': 0, 'ไม่อนุมัติ': 0 };
                                }
                                if (dailyData[dayOfMonth].hasOwnProperty(req.status)) {
                                    dailyData[dayOfMonth][req.status]++;
                                }
                            }
                        }
                    });
                    return dailyData;
                },
                // ... (filteredRequestsForTable, filteredAdminRequests เหมือนเดิม) ...
            },
            watch: {
                requests: { handler() { this.updateAllDashboardCharts(); }, deep: true },
                currentView(newView, oldView) {
                    if (newView === 'dashboardView') {
                        this.$nextTick(() => { this.updateAllDashboardCharts(); });
                    } else if (oldView === 'dashboardView' && newView !== 'dashboardView') {
                        this.destroyAllCharts();
                    }
                }
            },
            methods: {
                updateAllDashboardCharts() {
                    if (this.currentView === 'dashboardView') {
                        this.createLeaveDailyChart();
                        this.createPermissionDailyChart();
                    }
                },
                destroyAllCharts() {
                    if (this.leaveDailyChartInstance) { this.leaveDailyChartInstance.destroy(); this.leaveDailyChartInstance = null; }
                    if (this.permissionDailyChartInstance) { this.permissionDailyChartInstance.destroy(); this.permissionDailyChartInstance = null; }
                },
                // ... (setView, loadRequests, generateId, formatDate, formatTimeDisplay, openRequestFormModal, submitRequestToSheet, admin methods, etc. เหมือนเดิม) ...

                // --- Chart Creation Methods (Adjusted for Daily Data) ---
                createDailyBarChart(canvasId, chartTitle, chartData, instanceTracker) {
                    if (this[instanceTracker]) { this[instanceTracker].destroy(); }
                    const ctx = document.getElementById(canvasId);
                    if (!ctx || !ctx.getContext('2d')) return;

                    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    const labels = Array.from({ length: daysInMonth }, (_, i) => String(i + 1).padStart(2, '0')); // Labels for days 01-31 (or less)

                    if (Object.keys(chartData).length === 0 && labels.every(day => !chartData[day])) { // Check if no data for any day
                        const context = ctx.getContext('2d'); context.clearRect(0, 0, ctx.width, ctx.height);
                        context.font = "16px Prompt"; context.fillStyle = "#888"; context.textAlign = "center";
                        context.fillText(`ไม่มีข้อมูลสำหรับ "${chartTitle}" ในเดือนนี้`, ctx.width / 2, ctx.height / 2); return;
                    }

                    const datasets = [
                        { label: 'รอพิจารณา', data: labels.map(day => (chartData[day] ? chartData[day]['รอพิจารณา'] : 0) || 0), backgroundColor: 'rgba(255, 193, 7, 0.85)' }, // Vibrant Yellow
                        { label: 'อนุมัติ', data: labels.map(day => (chartData[day] ? chartData[day]['อนุมัติ'] : 0) || 0), backgroundColor: 'rgba(46, 204, 113, 0.85)' },    // Vibrant Green
                        { label: 'ไม่อนุมัติ', data: labels.map(day => (chartData[day] ? chartData[day]['ไม่อนุมัติ'] : 0) || 0), backgroundColor: 'rgba(231, 76, 60, 0.85)' }   // Vibrant Red
                    ];

                    this[instanceTracker] = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: labels, datasets: datasets }, // Labels are now '01', '02', ..., '31'
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { position: 'top', labels: {font: { family: 'Prompt'}}}, tooltip: { titleFont: { family: 'Prompt'}, bodyFont: { family: 'Prompt'}} },
                            scales: {
                                x: { stacked: true, ticks: { font: { family: 'Prompt' } }, title: { display: true, text: 'วันที่ในเดือนปัจจุบัน', font: { family: 'Prompt' } } },
                                y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, font: { family: 'Prompt' } } }
                            }
                        }
                    });
                },
                createLeaveDailyChart() {
                    this.createDailyBarChart('leaveDailyChart', 'การลา', this.leaveDailyChartDataCurrentMonth, 'leaveDailyChartInstance');
                },
                createPermissionDailyChart() {
                    this.createDailyBarChart('permissionDailyChart', 'การขออนุญาตออกนอกฯ', this.permissionDailyChartDataCurrentMonth, 'permissionDailyChartInstance');
                },
                // formatMonthYear is no longer needed for these daily charts
            },
            mounted() { /* ... (เหมือนเดิม) ... */ }
        });
    </script>
</body>
</html>
