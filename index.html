<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขออนุญาตออกนอกสถานศึกษา</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* Global Styles */
        body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }

        /* Header Styles */
        header { background: linear-gradient(135deg, #D32F2F, #FFC107); color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { display: flex; flex-direction: column; align-items: center; max-width: 1200px; margin: 0 auto; }
        #logo { max-height: 70px; width: auto; margin-bottom: 10px; border-radius: 5px; }
        #system-name { font-size: 1.4em; margin: 0; font-weight: 500; line-height: 1.2; }

        /* Navigation Styles */
        nav { background-color: #ffffff; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid #eee; }
        nav ul { list-style-type: none; padding: 0; margin: 0; display: flex; justify-content: center; flex-wrap: wrap; }
        nav ul li a { display: block; color: #333; text-align: center; padding: 14px 20px; text-decoration: none; font-weight: 500; transition: background-color 0.3s, color 0.3s; border-bottom: 3px solid transparent; }
        nav ul li a:hover, nav ul li a.active { color: #D32F2F; background-color: #FFF9C4; border-bottom-color: #D32F2F; }
        .admin-logout a { color: #555; }
        .admin-logout a:hover { background-color: #ffebee; color: #c0392b; border-bottom-color: #c0392b; }

        /* Main Content Styles */
        main { flex-grow: 1; padding: 20px; max-width: 1200px; width: 100%; margin: 0 auto; box-sizing: border-box; }
        .view-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-container h2 { color: #D32F2F; border-bottom: 2px solid #FFC107; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; font-weight: 500; }
        .view-container h2 i { margin-right: 8px; }

        /* Chart Styles */
        .charts-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-wrapper { flex: 1 1 45%; min-width: 280px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 350px; display: flex; flex-direction: column; }
        .chart-wrapper h3 { text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #555; flex-shrink: 0; }
        .chart-canvas-container { flex-grow: 1; position: relative; overflow: hidden; }

        /* SweetAlert2 Form Styles */
        .swal2-html-container { text-align: left !important; }
        .swal2-input, .swal2-textarea, .swal2-select { font-family: 'Prompt', sans-serif !important; margin-bottom: 10px !important; border-radius: 4px !important; border: 1px solid #ddd !important; padding: 10px !important; width: calc(100% - 20px) !important; box-sizing: border-box !important; }
        .swal2-label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .swal2-title { font-family: 'Prompt', sans-serif !important; color: #D32F2F !important; }
        .swal2-confirm { background-color: #D32F2F !important; font-family: 'Prompt', sans-serif !important; }
        .swal2-cancel { font-family: 'Prompt', sans-serif !important; }
        .swal2-validation-message { font-family: 'Prompt', sans-serif !important; }
        .swal2-popup { width: 600px !important; max-width: 90% !important; }
        @media (min-width: 768px) { .swal2-popup { width: 700px !important; max-width: 700px !important; } }
        @media (max-width: 767px) { .swal2-popup { width: 90vw !important; max-width: 90vw !important; } }
        @media (max-width: 480px) { .swal2-popup { width: 95vw !important; max-width: 95vw !important; } }

        /* Button Styles (Admin Dashboard Actions) */
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 1em; transition: background-color 0.3s, transform 0.1s; margin-right: 5px; margin-bottom: 5px; }
        .btn:active { transform: translateY(1px); }
        .btn-approve { background-color: #4CAF50; color: white; } .btn-approve:hover { background-color: #388E3C; }
        .btn-reject { background-color: #f44336; color: white; } .btn-reject:hover { background-color: #c62828; }
        .btn-delete { background-color: #757575; color: white; } .btn-delete:hover { background-color: #525252; }

        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: 500; color: #D32F2F; }
        tr:nth-child(even) { background-color: #f9f9f9; } tr:hover { background-color: #f1f1f1; }
        .status-pending { background-color: #fff9c4; } .status-approved { background-color: #c8e6c9; } .status-rejected { background-color: #ffcdd2; }
        .no-data { text-align: center; font-style: italic; color: #777; padding: 20px; }

        /* Filter and Search */
        .filter-search-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input, .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Prompt', sans-serif; }
        .search-input { flex-grow: 1; } .filter-select { min-width: 180px; }

        /* Footer Styles */
        footer { background-color: #333; color: #aaa; text-align: center; padding: 15px; font-size: 0.9em; margin-top: auto; }

        /* Responsive Design for main layout */
        @media (max-width: 992px) { .chart-wrapper { flex-basis: 100%; max-width: 100%; height: 320px; } }
        @media (max-width: 768px) { #system-name { font-size: 1.2em; } #logo { max-height: 60px; } nav ul { flex-direction: column; } nav ul li a { padding: 12px 10px; border-bottom-width: 2px; } .charts-container { flex-direction: column; } .chart-wrapper { min-width: unset; width: 100%; max-width: 100%; height: 300px; } .filter-search-container { flex-direction: column; } .search-input, .filter-select { width: 100%; } .btn { width: 100%; margin-bottom: 10px; margin-right: 0;} .table-responsive td, .table-responsive th { font-size: 0.9em; padding: 8px;} }
        @media (max-width: 480px) { #system-name { font-size: 1em; } #logo { max-height: 50px; } .view-container h2 { font-size: 1.3em; } .chart-wrapper { height: 280px; } }
    </style>
</head>
<body>
    <div id="app">
        <header><!-- ... Header content ... --></header>
        <nav><!-- ... Nav content ... --></nav>
        <main><!-- ... Main content views ... --></main>
        <footer><!-- ... Footer content ... --></footer>
    </div>

    <script>
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrmn6WLJfs5q7ye3Mo95kEraPE8BuXdSHji0Ekwlr9JO20zPrIap0ujQnqAG2wah-W/exec'; // <--- ใส่ URL ที่ได้จากการ Deploy Apps Script ใหม่

        const app = new Vue({
            el: '#app',
            data: {
                currentView: 'dashboardView',
                requests: [],
                newRequest: { requesterName: '', leaveDate: '', leaveTimeFrom: '', leaveTimeTo: '', reason: '' },
                adminCredentials: { username: '', password: '' },
                isAdminLoggedIn: false,
                searchTerm: '',
                filterStatus: '',
                searchTermAdmin: '',
                filterStatusAdmin: 'รอพิจารณา',
                pieChartInstance: null,
                barChartInstance: null,
                isLoading: false, // For general loading state
            },
            computed: { /* ... (เหมือนเดิม) ... */ },
            watch: { /* ... (เหมือนเดิม) ... */ },
            methods: {
                conditionalUpdateCharts() { if (this.currentView === 'dashboardView') { this.updateCharts(); } },
                destroyCharts() { /* ... (เหมือนเดิม) ... */ },
                setView(view) { /* ... (เหมือนเดิม) ... */ },

                async loadRequests() {
                    this.isLoading = true;
                    Swal.fire({
                        title: 'กำลังโหลดข้อมูล...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    try {
                        const response = await fetch(APP_SCRIPT_URL);
                        if (!response.ok) {
                            throw new Error(`Network response was not ok: ${response.statusText}`);
                        }
                        const data = await response.json();
                        // Map data from sheet to match frontend structure if necessary
                        // Apps Script doGet already returns keys like "ID", "ชื่อ-สกุล ผู้ขออนุญาต"
                        // but frontend uses "requesterName", "leaveDate", etc.
                        this.requests = data.map(item => ({
                            id: item.ID, // Assuming Apps Script returns "ID"
                            requesterName: item['ชื่อ-สกุล ผู้ขออนุญาต'],
                            leaveDate: item['วันที่ต้องการออก'], // Ensure this is ISO string or parseable
                            leaveTimeFrom: item['ตั้งแต่เวลา'],
                            leaveTimeTo: item['ถึงเวลา'],
                            reason: item['เหตุผล'],
                            status: item['สถานะ'],
                            submissionDate: item['วันที่ยื่น'] // Ensure this is ISO string or parseable
                        }));

                        Swal.close();
                        if (this.currentView === 'dashboardView') {
                            this.$nextTick(() => { this.updateCharts(); });
                        }
                    } catch (error) {
                        console.error('Error loading requests:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: 'ไม่สามารถโหลดข้อมูลได้: ' + error.message, confirmButtonColor: '#D32F2F' });
                    } finally {
                        this.isLoading = false;
                    }
                },

                // REMOVED saveRequests() as we now save per action

                generateId() { return '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36); },
                formatDate(dateString, includeTime = false) { /* ... (เหมือนเดิม) ... */ },

                openRequestFormModal() {
                    this.newRequest = { requesterName: '', leaveDate: '', leaveTimeFrom: '', leaveTimeTo: '', reason: '' };
                    Swal.fire({ /* ... (Modal HTML and preConfirm - เหมือนเดิม) ... */
                        title: '<i class="fas fa-file-alt"></i> ยื่นคำขออนุญาต',
                        html: `
                            <div><label for="swal-requesterName" class="swal2-label">ชื่อ-สกุล ผู้ขออนุญาต:</label><input id="swal-requesterName" class="swal2-input" placeholder="กรอกชื่อ-สกุล"></div>
                            <div><label for="swal-leaveDate" class="swal2-label">วันที่ต้องการออก:</label><input id="swal-leaveDate" type="date" class="swal2-input"></div>
                            <div><label for="swal-leaveTimeFrom" class="swal2-label">ตั้งแต่เวลา:</label><input id="swal-leaveTimeFrom" type="time" class="swal2-input"></div>
                            <div><label for="swal-leaveTimeTo" class="swal2-label">ถึงเวลา:</label><input id="swal-leaveTimeTo" type="time" class="swal2-input"></div>
                            <div><label for="swal-reason" class="swal2-label">เหตุผล:</label><textarea id="swal-reason" class="swal2-textarea" placeholder="ระบุเหตุผล" rows="3"></textarea></div>
                        `,
                        confirmButtonText: 'ยื่นคำขอ', focusConfirm: false, showCancelButton: true, cancelButtonText: 'ยกเลิก',
                        preConfirm: () => {
                            const data = {
                                requesterName: document.getElementById('swal-requesterName').value,
                                leaveDate: document.getElementById('swal-leaveDate').value,
                                leaveTimeFrom: document.getElementById('swal-leaveTimeFrom').value,
                                leaveTimeTo: document.getElementById('swal-leaveTimeTo').value,
                                reason: document.getElementById('swal-reason').value,
                            };
                            if (!data.requesterName || !data.leaveDate || !data.leaveTimeFrom || !data.leaveTimeTo || !data.reason) {
                                Swal.showValidationMessage(`กรุณากรอกข้อมูลให้ครบทุกช่อง`); return false;
                            }
                            return data;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) { this.submitRequestToSheet(result.value); }
                    });
                },

                async submitRequestToSheet(formData) {
                    const requestData = {
                        id: this.generateId(),
                        requesterName: formData.requesterName,
                        leaveDate: formData.leaveDate,
                        leaveTimeFrom: formData.leaveTimeFrom,
                        leaveTimeTo: formData.leaveTimeTo,
                        reason: formData.reason,
                        status: 'รอพิจารณา',
                        submissionDate: new Date().toISOString()
                    };

                    Swal.fire({ title: 'กำลังบันทึกข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                    try {
                        const response = await fetch(APP_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'create', data: requestData }),
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const result = await response.json();
                        if (result.success) {
                            Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ!', text: 'คำขอของคุณถูกส่งเข้าระบบแล้ว', confirmButtonColor: '#D32F2F' });
                            this.loadRequests(); // Reload data from sheet
                        } else {
                            throw new Error(result.message || 'ไม่สามารถบันทึกข้อมูลได้');
                        }
                    } catch (error) {
                        console.error('Error submitting request:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: 'ไม่สามารถบันทึกข้อมูล: ' + error.message, confirmButtonColor: '#D32F2F' });
                    }
                },

                openAdminLoginModal() { /* ... (เหมือนเดิม) ... */ },
                loginAdmin(credentials) { /* ... (เหมือนเดิม) ... */ },
                logoutAdmin() { /* ... (เหมือนเดิม) ... */ },

                async updateRequestStatusInSheet(id, newStatus, successMessage, actionVerb) {
                    Swal.fire({ title: `กำลัง${actionVerb}...`, text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                    try {
                        const response = await fetch(APP_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'updateStatus', id: id, status: newStatus }),
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const result = await response.json();
                        if (result.success) {
                            Swal.fire({icon: 'success', title: successMessage, confirmButtonColor: '#D32F2F'});
                            this.loadRequests(); // Reload data
                        } else {
                            throw new Error(result.message || `ไม่สามารถ${actionVerb}ได้`);
                        }
                    } catch (error) {
                        console.error(`Error ${actionVerb} request:`, error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: `ไม่สามารถ${actionVerb}สถานะ: ` + error.message, confirmButtonColor: '#D32F2F' });
                    }
                },
                approveRequest(id) {
                    Swal.fire({ title: 'ยืนยันการอนุมัติ?', text: "คุณต้องการอนุมัติคำขอนี้ใช่หรือไม่?", icon: 'question', showCancelButton: true, confirmButtonColor: '#4CAF50', cancelButtonColor: '#757575', confirmButtonText: 'อนุมัติ', cancelButtonText: 'ยกเลิก'})
                    .then((result) => {
                        if (result.isConfirmed) {
                            this.updateRequestStatusInSheet(id, 'อนุมัติ', 'อนุมัติแล้ว!', 'อนุมัติ');
                        }
                    });
                },
                rejectRequest(id) {
                     Swal.fire({ title: 'ยืนยันการไม่อนุมัติ?', text: "คุณต้องการไม่อนุมัติคำขอนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#f44336', cancelButtonColor: '#757575', confirmButtonText: 'ไม่อนุมัติ', cancelButtonText: 'ยกเลิก'})
                     .then((result) => {
                        if (result.isConfirmed) {
                            this.updateRequestStatusInSheet(id, 'ไม่อนุมัติ', 'ไม่อนุมัติแล้ว!', 'ไม่อนุมัติ');
                        }
                    });
                },
                async deleteRequestFromSheet(id) {
                    Swal.fire({ title: 'กำลังลบข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                    try {
                        const response = await fetch(APP_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'delete', id: id }),
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const result = await response.json();
                        if (result.success) {
                            Swal.fire({icon: 'success', title: 'ลบสำเร็จ!', text: 'คำขอถูกลบออกจากระบบแล้ว', confirmButtonColor: '#D32F2F'});
                            this.loadRequests(); // Reload data
                        } else {
                            throw new Error(result.message || 'ไม่สามารถลบข้อมูลได้');
                        }
                    } catch (error) {
                        console.error('Error deleting request:', error);
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: 'ไม่สามารถลบข้อมูล: ' + error.message, confirmButtonColor: '#D32F2F' });
                    }
                },
                deleteRequest(id) {
                    Swal.fire({ title: 'ยืนยันการลบ?', text: "คุณต้องการลบคำขอนี้ออกจากระบบใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้", icon: 'error', showCancelButton: true, confirmButtonColor: '#D32F2F', cancelButtonColor: '#757575', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'})
                    .then((result) => {
                        if (result.isConfirmed) {
                            this.deleteRequestFromSheet(id);
                        }
                    });
                },

                getStatusClass(status) { /* ... (เหมือนเดิม) ... */ },
                updateCharts() { /* ... (เหมือนเดิม) ... */ },
                createPieChart() { /* ... (เหมือนเดิม) ... */ },
                createBarChart() { /* ... (เหมือนเดิม) ... */ }
            },
            mounted() {
                this.loadRequests(); // Load initial data from Google Sheet
                if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                    this.isAdminLoggedIn = true;
                } else {
                     this.currentView = 'dashboardView';
                }
            }
        });
    </script>
</body>
</html>
