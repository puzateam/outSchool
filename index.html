<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการลา และขออนุญาตออกนอกสถานศึกษา</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* ... CSS ทั้งหมดเหมือนเดิมจากครั้งที่แล้ว ... */
        body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        header { background: linear-gradient(135deg, #D32F2F, #FFC107); color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { display: flex; flex-direction: column; align-items: center; max-width: 1200px; margin: 0 auto; }
        #logo { max-height: 70px; width: auto; margin-bottom: 10px; border-radius: 5px; }
        #system-name { font-size: 1.4em; margin: 0; font-weight: 500; line-height: 1.2; }
        nav { background-color: #ffffff; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid #eee; }
        nav ul { list-style-type: none; padding: 0; margin: 0; display: flex; justify-content: center; flex-wrap: wrap; }
        nav ul li a { display: block; color: #333; text-align: center; padding: 14px 20px; text-decoration: none; font-weight: 500; transition: background-color 0.3s, color 0.3s; border-bottom: 3px solid transparent; }
        nav ul li a:hover, nav ul li a.active { color: #D32F2F; background-color: #FFF9C4; border-bottom-color: #D32F2F; }
        .admin-logout a { color: #555; }
        .admin-logout a:hover { background-color: #ffebee; color: #c0392b; border-bottom-color: #c0392b; }
        main { flex-grow: 1; padding: 20px; max-width: 1200px; width: 100%; margin: 0 auto; box-sizing: border-box; }
        .view-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-container h2 { color: #D32F2F; border-bottom: 2px solid #FFC107; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; font-weight: 500; }
        .view-container h2 i { margin-right: 8px; }
        .charts-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-wrapper { flex: 1 1 45%; min-width: 280px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 400px; display: flex; flex-direction: column; }
        .chart-wrapper h3 { text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #555; flex-shrink: 0; }
        .chart-canvas-container { flex-grow: 1; position: relative; overflow: hidden; }
        .swal2-html-container { text-align: left !important; }
        .swal2-input, .swal2-textarea, .swal2-select { font-family: 'Prompt', sans-serif !important; margin-bottom: 10px !important; border-radius: 4px !important; border: 1px solid #ddd !important; padding: 10px !important; width: calc(100% - 20px) !important; box-sizing: border-box !important; }
        .swal2-label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .swal2-title { font-family: 'Prompt', sans-serif !important; color: #D32F2F !important; }
        .swal2-confirm { background-color: #D32F2F !important; font-family: 'Prompt', sans-serif !important; }
        .swal2-cancel { font-family: 'Prompt', sans-serif !important; }
        .swal2-validation-message { font-family: 'Prompt', sans-serif !important; }
        .swal2-popup { width: 600px !important; max-width: 90% !important; }
        @media (min-width: 768px) { .swal2-popup { width: 700px !important; max-width: 700px !important; } }
        @media (max-width: 767px) { .swal2-popup { width: 90vw !important; max-width: 90vw !important; } }
        @media (max-width: 480px) { .swal2-popup { width: 95vw !important; max-width: 95vw !important; } }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 1em; transition: background-color 0.3s, transform 0.1s; margin-right: 5px; margin-bottom: 5px; }
        .btn:active { transform: translateY(1px); }
        .btn-approve { background-color: #2ecc71; color: white; } .btn-approve:hover { background-color: #27ae60; }
        .btn-reject { background-color: #e74c3c; color: white; } .btn-reject:hover { background-color: #c0392b; }
        .btn-delete { background-color: #95a5a6; color: white; } .btn-delete:hover { background-color: #7f8c8d; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px 10px; vertical-align: middle; }
        th { background-color: #ecf0f1; font-weight: 500; color: #2c3e50; text-align: center; }
        td { text-align: left; }
        td.cell-center, td:first-child { text-align: center; }
        .dashboard-table td:nth-child(7), .admin-dashboard-table td:nth-child(6) { text-align: center; }
        tr:nth-child(even) { background-color: #fdfdfd; } tr:hover { background-color: #f1f1f1; }
        .status-pending { background-color: #f1c40f; color: #fff; }
        .status-approved { background-color: #2ecc71; color: #fff; }
        .status-rejected { background-color: #e74c3c; color: #fff; }
        .no-data { text-align: center; font-style: italic; color: #777; padding: 20px; }
        .filter-search-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-search-container label { margin-right: 5px; font-weight: 500; }
        .search-input, .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Prompt', sans-serif; }
        .search-input { flex-grow: 1; } .filter-select { min-width: 180px; }
        footer { background-color: #34495e; color: #bdc3c7; text-align: center; padding: 15px; font-size: 0.9em; margin-top: auto; }
        @media (max-width: 992px) { .chart-wrapper { flex-basis: 100%; max-width: 100%; height: 320px; } }
        @media (max-width: 768px) { #system-name { font-size: 1.2em; } #logo { max-height: 60px; } nav ul { flex-direction: column; } nav ul li a { padding: 12px 10px; border-bottom-width: 2px; } .charts-container { flex-direction: column; } .chart-wrapper { min-width: unset; width: 100%; max-width: 100%; height: 350px; } .filter-search-container { flex-direction: column; align-items: stretch; } .filter-search-container label { margin-bottom: 5px;} .filter-search-container .search-input, .filter-search-container .filter-select { width: 100%; margin-bottom:10px;} .btn { width: 100%; margin-bottom: 10px; margin-right: 0;} .table-responsive td, .table-responsive th { font-size: 0.9em; padding: 8px;} }
        @media (max-width: 480px) { #system-name { font-size: 1em; } #logo { max-height: 50px; } .view-container h2 { font-size: 1.3em; } .chart-wrapper { height: 300px; } }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="header-content">
                <img src='https://i.postimg.cc/d3PbrGqC/logo-School.png' border='0' alt='logo-School' id="logo"/>
                <h1 id="system-name">ระบบการลา และขออนุญาตออกนอกสถานศึกษา<br>ของโรงเรียนชุมชนบ้านแม่หละป่าป๋วย</h1>
            </div>
        </header>

        <nav>
            <ul>
                <li><a href="#" @click.prevent="setView('dashboardView')" :class="{active: currentView === 'dashboardView'}">แดชบอร์ด</a></li>
                <li><a href="#" @click.prevent="openRequestFormModal">ยื่นคำขอ</a></li>
                <li>
                    <!-- Show "ผู้บริหาร" link if not logged in, which opens login modal -->
                    <a v-if="!isAdminLoggedIn" href="#" @click.prevent="openAdminLoginModal" :class="{active: currentView === 'adminLoginModalActiveState'}">ผู้บริหาร</a>
                    <!-- Show "แดชบอร์ดผู้บริหาร" link if logged in, which sets the view -->
                    <a v-if="isAdminLoggedIn" href="#" @click.prevent="setView('adminDashboard')" :class="{active: currentView === 'adminDashboard'}">แดชบอร์ดผู้บริหาร</a>
                </li>
                <li v-if="isAdminLoggedIn" class="admin-logout"><a href="#" @click.prevent="logoutAdmin">ออกจากระบบผู้บริหาร</a></li>
            </ul>
        </nav>

        <main>
            <!-- ... (Main content: Dashboard, Admin Dashboard) เหมือนเดิมจากครั้งที่แล้ว ... -->
        </main>

        <footer>
            <p>พัฒนาโดย นายสุชาติ เวียงชัย © 2025 ระบบการลา และขออนุญาตออกนอกสถานศึกษาออนไลน์</p>
        </footer>
    </div>

    <script>
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrmn6WLJfs5q7ye3Mo95kEraPE8BuXdSHji0Ekwlr9JO20zPrIap0ujQnqAG2wah-W/exec';

        const app = new Vue({
            el: '#app',
            data: {
                currentView: 'dashboardView', // Default view
                requests: [],
                newRequest: { requesterName: '', requestType: 'ลา', leaveDate: '', leaveTimeFrom: '08:00', leaveTimeTo: '16:00', reason: '' },
                adminCredentials: { username: '', password: '' },
                isAdminLoggedIn: false,
                searchTerm: '',
                filterStatus: '',
                searchTermAdmin: '',
                filterTypeAdmin: '',
                filterStatusAdmin: 'รอพิจารณา',
                leaveMonthlyChartInstance: null,
                permissionMonthlyChartInstance: null,
                isLoading: false,
                // A temporary state to highlight "ผู้บริหาร" when its modal is conceptually active,
                // as currentView won't change just for opening a modal.
                adminLoginModalActiveState: false
            },
            computed: { /* ... (เหมือนเดิม) ... */ },
            watch: { /* ... (เหมือนเดิม) ... */ },
            methods: {
                updateAllDashboardCharts() { /* ... (เหมือนเดิม) ... */ },
                destroyAllCharts() { /* ... (เหมือนเดิม) ... */ },

                setView(view) {
                    this.currentView = view;
                    this.adminLoginModalActiveState = false; // Reset when view changes

                    // If navigating to admin dashboard without being logged in, redirect to login modal
                    if (view === 'adminDashboard' && !this.isAdminLoggedIn) {
                        this.currentView = 'dashboardView'; // Revert to a safe default view
                        this.openAdminLoginModal();
                    }
                    if (view === 'dashboardView') {
                        this.searchTerm = '';
                        this.filterStatus = '';
                        // Ensure charts are updated if navigating to dashboard
                        this.$nextTick(() => this.updateAllDashboardCharts());
                    }
                },

                async loadRequests() { /* ... (เหมือนเดิม, รวมถึงการ map key และ error handling) ... */ },
                generateId() { /* ... (เหมือนเดิม) ... */ },
                formatDate(dateString, includeTime = false) { /* ... (เหมือนเดิม) ... */ },
                formatTimeDisplay(timeString) { /* ... (เหมือนเดิม) ... */ },

                openRequestFormModal() {
                    // This method should correctly open the SweetAlert2 modal for submitting a request.
                    // The logic inside this method (creating the Swal with HTML form) from the previous answer should work.
                    this.newRequest = { requesterName: '', requestType: 'ลา', leaveDate: '', leaveTimeFrom: '08:00', leaveTimeTo: '16:00', reason: '' };
                    Swal.fire({
                        title: '<i class="fas fa-file-alt"></i> ยื่นคำขอ',
                        html: `... (HTML ของฟอร์มเหมือนเดิมจากครั้งที่แล้ว, รวมถึง select สำหรับ requestType และ input เวลา) ...`,
                        didOpen: () => { /* ... (logic การจัดการเวลาอัตโนมัติเมื่อเลือก "ลา") ... */ },
                        confirmButtonText: 'ยื่นคำขอ', /* ... (ที่เหลือเหมือนเดิม) ... */
                        preConfirm: () => { /* ... (validation และ return data) ... */ }
                    }).then((result) => { if (result.isConfirmed) { this.submitRequestToSheet(result.value); }});
                },
                async submitRequestToSheet(formData) { /* ... (เหมือนเดิม) ... */ },

                openAdminLoginModal() {
                    this.adminLoginModalActiveState = true; // Highlight "ผู้บริหาร" menu
                    this.adminCredentials = { username: '', password: '' };
                    Swal.fire({
                        title: '<i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบผู้บริหาร',
                        html: `... (HTML ของฟอร์มล็อกอินเหมือนเดิม) ...`,
                        confirmButtonText: 'เข้าสู่ระบบ', /* ... (ที่เหลือเหมือนเดิม) ... */
                        preConfirm: () => { /* ... (validation และ return credentials) ... */ },
                        willClose: () => {
                            this.adminLoginModalActiveState = false; // De-highlight menu when modal closes
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.loginAdmin(result.value);
                        }
                    });
                },
                loginAdmin(credentials) {
                    if (credentials.username === 'mlpyboss' && credentials.password === '06052520') {
                        this.isAdminLoggedIn = true;
                        sessionStorage.setItem('isAdminLoggedIn', 'true'); // Persist login state
                        this.setView('adminDashboard'); // Navigate to admin dashboard
                        Swal.fire({ icon: 'success', title: 'เข้าสู่ระบบสำเร็จ', text: 'ยินดีต้อนรับผู้บริหาร', timer: 1500, showConfirmButton: false });
                    } else {
                        Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', confirmButtonColor: '#D32F2F' })
                        .then(() => {
                            this.openAdminLoginModal(); // Re-open login modal on failure
                        });
                    }
                },
                logoutAdmin() {
                    this.isAdminLoggedIn = false;
                    sessionStorage.removeItem('isAdminLoggedIn');
                    this.setView('dashboardView'); // Go to main dashboard after logout
                    Swal.fire({ icon: 'info', title: 'ออกจากระบบแล้ว', timer: 1500, showConfirmButton: false });
                },

                // CRUD operations on requests (approve, reject, delete)
                async updateRequestStatusInSheet(id, newStatus, successMessage, actionVerb) { /* ... (เหมือนเดิม) ... */ },
                approveRequest(id) { /* ... (เหมือนเดิม) ... */ },
                rejectRequest(id) { /* ... (เหมือนเดิม) ... */ },
                async deleteRequestFromSheet(id) { /* ... (เหมือนเดิม) ... */ },
                deleteRequest(id) { /* ... (เหมือนเดิม) ... */ },

                getStatusClass(status) { /* ... (เหมือนเดิม) ... */ },
                // Chart creation methods
                createMonthlyBarChart(canvasId, chartTitle, chartData, instanceTracker) { /* ... (เหมือนเดิม) ... */ },
                createLeaveMonthlyChart() { /* ... (เหมือนเดิม) ... */ },
                createPermissionMonthlyChart() { /* ... (เหมือนเดิม) ... */ },
                formatMonthYear(monthYearStr) { /* ... (เหมือนเดิม) ... */ }
            },
            mounted() {
                // Check sessionStorage for persisted login state
                if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                    this.isAdminLoggedIn = true;
                    // Optionally, set currentView to 'adminDashboard' if you want to land there directly after refresh if logged in.
                    // However, for now, let's keep it on dashboardView and let user click the menu.
                    // this.currentView = 'adminDashboard';
                }
                this.loadRequests(); // Load initial data
            }
        });
    </script>
</body>
</html>
